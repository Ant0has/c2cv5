# Техническое задание: Настройка целей Яндекс.Метрики для city2city B2B

**Проект:** city2city.ru  
**Страница:** /dlya-biznesa  
**Дата:** 21 января 2026  
**Версия:** 3.0  

---

## 1. Доступные типы целей в Метрике

На основе реального интерфейса:

| Тип условия | Описание |
|-------------|----------|
| Количество просмотров | N страниц за визит |
| Посещение страниц | URL содержит / совпадает / начинается с / регулярка |
| JavaScript-событие | Вызов `ym(ID, 'reachGoal', 'goal_id')` |
| Продолжительность визита | Время на сайте |
| Составная цель | **Воронка** — шаги выполняются последовательно |
| Клик по номеру телефона | Автоматически отслеживает `tel:` |
| Клик по email | Автоматически отслеживает `mailto:` |
| Отправка формы | Автоматически отслеживает submit |
| Переход в мессенджер | Автоматически отслеживает ссылки на мессенджеры |
| Скачивание файлов | Автоматически отслеживает загрузки |
| Поиск по сайту | Автоматически отслеживает поиск |
| Клик по кнопке | Автоматически отслеживает кнопки |
| Переход в соц. сеть | Автоматически отслеживает ссылки на соцсети |
| Возвращение из платежной системы | Для e-commerce |

---

## 2. Структура целей для B2B

### 2.1. Основные цели (создаются вручную)

| № | Название | Тип условия | Настройка |
|---|----------|-------------|-----------|
| 1 | B2B: Форма отправлена | JavaScript-событие | `b2b_form_submit` |
| 2 | B2B: Клик «Получить предложение» | JavaScript-событие | `b2b_cta_offer` |
| 3 | B2B: Калькулятор использован | JavaScript-событие | `b2b_calc_used` |
| 4 | B2B: Клик «Рассчитать маршрут» | JavaScript-событие | `b2b_calc_route` |
| 5 | B2B: Клик по телефону | Клик по номеру телефона | — |
| 6 | B2B: Клик по email | Клик по email | — |
| 7 | B2B: Клик в мессенджер | Переход в мессенджер | — |
| 8 | B2B: FAQ раскрыт | JavaScript-событие | `b2b_faq_opened` |
| 9 | B2B: Любая конверсия | JavaScript-событие | `b2b_any_conversion` |

### 2.2. Воронка для анализа (составная цель)

| № | Название | Тип условия | Назначение |
|---|----------|-------------|------------|
| 10 | B2B: Воронка до заявки | Составная цель | Анализ пути пользователя |

### 2.3. Офлайн-конверсии (из CRM)

| Идентификатор | Описание | Источник |
|---------------|----------|----------|
| `b2b_deal_closed` | Сделка закрыта | Загрузка данных из CRM |

---

## 3. Пошаговое создание целей

### Путь: Метрика → Настройка → Цели → Добавить цель

---

### Цель 1: B2B: Форма отправлена

```
Название: B2B: Форма отправлена
Тип условия: JavaScript-событие
Идентификатор цели: b2b_form_submit
```

---

### Цель 2: B2B: Клик «Получить предложение»

```
Название: B2B: Клик «Получить предложение»
Тип условия: JavaScript-событие
Идентификатор цели: b2b_cta_offer
```

---

### Цель 3: B2B: Калькулятор использован

```
Название: B2B: Калькулятор использован
Тип условия: JavaScript-событие
Идентификатор цели: b2b_calc_used
```

---

### Цель 4: B2B: Клик «Рассчитать маршрут»

```
Название: B2B: Клик «Рассчитать маршрут»
Тип условия: JavaScript-событие
Идентификатор цели: b2b_calc_route
```

---

### Цель 5: B2B: Клик по телефону

```
Название: B2B: Клик по телефону
Тип условия: Клик по номеру телефона
(дополнительных настроек нет — Метрика отслеживает автоматически)
```

---

### Цель 6: B2B: Клик по email

```
Название: B2B: Клик по email
Тип условия: Клик по email
(дополнительных настроек нет — Метрика отслеживает автоматически)
```

---

### Цель 7: B2B: Клик в мессенджер

```
Название: B2B: Клик в мессенджер
Тип условия: Переход в мессенджер
(дополнительных настроек нет — Метрика отслеживает автоматически)
```

---

### Цель 8: B2B: FAQ раскрыт

```
Название: B2B: FAQ раскрыт
Тип условия: JavaScript-событие
Идентификатор цели: b2b_faq_opened
```

---

### Цель 9: B2B: Любая конверсия (для Директа)

**Зачем:** Одна цель, которая срабатывает при любом целевом действии. Удобно для оптимизации в Директе, когда мало данных.

```
Название: B2B: Любая конверсия
Тип условия: JavaScript-событие
Идентификатор цели: b2b_any_conversion
```

---

### Цель 10: B2B: Воронка до заявки (составная цель)

**Зачем:** Анализ, сколько людей проходят путь от захода до заявки.

```
Название: B2B: Воронка до заявки
Тип условия: Составная цель

Шаг 1:
  Условие: url: содержит
  Значение: /dlya-biznesa

Шаг 2:
  Условие: событие: идентификатор цели
  Значение: b2b_calc_used

Шаг 3:
  Условие: событие: идентификатор цели
  Значение: b2b_form_submit
```

**Важно:** Составная цель — это **воронка**. Шаги выполняются последовательно. Она показывает конверсию между этапами, но НЕ подходит для оптимизации Директа на «любое из действий».

---

## 4. Настройка офлайн-конверсий

### 4.1. Путь

Метрика → Настройка → Загрузка данных → Офлайн-конверсии

### 4.2. Включение

1. Нажать «Включить»
2. Выбрать способ загрузки: CSV или API

### 4.3. Формат CSV

По yclid (приоритет):
```csv
yclid,target,datetime,price,currency
123456789,b2b_deal_closed,2026-01-20 15:30:00,45000,RUB
```

По ClientID (если нет yclid):
```csv
client_id,target,datetime,price,currency
1234567890.1234567890,b2b_deal_closed,2026-01-20 15:30:00,45000,RUB
```

### 4.4. После загрузки

Метрика автоматически создаст цель `b2b_deal_closed`. Её можно использовать в Директе.

---

## 5. JavaScript-код для трекинга

### 5.1. Основной скрипт

**Файл:** `b2b-tracking.js`

```javascript
/**
 * Трекинг целей для страницы /dlya-biznesa
 * city2city.ru
 */
(function() {
  'use strict';
  
  // =====================================================
  // КОНФИГУРАЦИЯ
  // =====================================================
  
  const CONFIG = {
    counterId: 36995060, // city2city.ru
    debug: false,      // true для отладки в консоли
    page: '/dlya-biznesa'
  };
  
  // Ценность действий для Директа (order_price)
  const ACTION_VALUES = {
    'b2b_form_submit': 100,
    'b2b_cta_offer': 100,
    'b2b_phone_click': 50,
    'b2b_messenger_click': 40,
    'b2b_calc_used': 20,
    'b2b_calc_route': 20,
    'b2b_faq_opened': 5
  };
  
  // =====================================================
  // УТИЛИТЫ
  // =====================================================
  
  /**
   * Отправка цели в Метрику
   */
  function sendGoal(goalId, params) {
    if (typeof ym === 'undefined') {
      console.warn('[C2C Tracking] ym not found');
      return;
    }
    
    if (CONFIG.debug) {
      console.log('[C2C Tracking] Goal:', goalId, params || '');
    }
    
    // Отправляем конкретную цель
    ym(CONFIG.counterId, 'reachGoal', goalId, params || {});
    
    // Отправляем общую цель с ценностью (для Директа)
    const value = ACTION_VALUES[goalId] || 10;
    ym(CONFIG.counterId, 'reachGoal', 'b2b_any_conversion', {
      action: goalId,
      order_price: value
    });
    
    if (CONFIG.debug) {
      console.log('[C2C Tracking] Also sent b2b_any_conversion with value:', value);
    }
  }
  
  /**
   * Проверка, что мы на нужной странице
   */
  function isTargetPage() {
    return window.location.pathname === CONFIG.page || 
           window.location.pathname === CONFIG.page + '/';
  }
  
  /**
   * Делегирование событий
   */
  function delegate(selector, event, handler) {
    document.addEventListener(event, function(e) {
      const target = e.target.closest(selector);
      if (target) {
        handler(e, target);
      }
    });
  }
  
  // =====================================================
  // ТРЕКИНГ ФОРМЫ
  // =====================================================
  
  function trackForm() {
    const form = document.querySelector('form');
    if (!form) return;
    
    form.addEventListener('submit', function(e) {
      sendGoal('b2b_form_submit', {
        form_location: 'hero'
      });
    });
  }
  
  // =====================================================
  // ТРЕКИНГ CTA-КНОПОК
  // =====================================================
  
  function trackCTAButtons() {
    delegate('button', 'click', function(e, btn) {
      const text = btn.textContent.trim().toLowerCase();
      
      if (text.includes('получить предложение')) {
        sendGoal('b2b_cta_offer', {
          button_text: btn.textContent.trim()
        });
      }
      
      if (text.includes('рассчитать свой маршрут')) {
        sendGoal('b2b_calc_route');
      }
    });
  }
  
  // =====================================================
  // ТРЕКИНГ КАЛЬКУЛЯТОРА
  // =====================================================
  
  function trackCalculator() {
    delegate('button', 'click', function(e, btn) {
      const text = btn.textContent.trim().toLowerCase();
      
      // Кнопка "Рассчитать" в калькуляторе
      if (text === 'рассчитать') {
        const fromInput = document.querySelector('input[placeholder="Москва"]');
        const toInput = document.querySelector('input[placeholder="Нижний Новгород"]');
        
        sendGoal('b2b_calc_used', {
          from: fromInput ? fromInput.value : '',
          to: toInput ? toInput.value : ''
        });
      }
    });
  }
  
  // =====================================================
  // ТРЕКИНГ FAQ
  // =====================================================
  
  function trackFAQ() {
    const faqButtons = document.querySelectorAll('button');
    
    faqButtons.forEach(function(btn) {
      const text = btn.textContent.trim();
      
      // FAQ вопросы содержат "?"
      if (text.includes('?') && text.length > 20) {
        btn.addEventListener('click', function() {
          sendGoal('b2b_faq_opened', {
            question: text.substring(0, 50)
          });
        }, { once: true });
      }
    });
  }
  
  // =====================================================
  // ТРЕКИНГ КОНТАКТОВ (дополнительно к автоцелям)
  // =====================================================
  
  function trackContacts() {
    // Клик по телефону — дублируем в общую цель
    delegate('a[href^="tel:"]', 'click', function(e, link) {
      sendGoal('b2b_phone_click', {
        phone: link.href.replace('tel:', '')
      });
    });
    
    // Клик в мессенджер — дублируем в общую цель
    delegate('a[href*="t.me"], a[href*="wa.me"], a[href*="max.ru"]', 'click', function(e, link) {
      let messenger = 'unknown';
      if (link.href.includes('t.me')) messenger = 'telegram';
      if (link.href.includes('wa.me')) messenger = 'whatsapp';
      if (link.href.includes('max.ru')) messenger = 'vk_max';
      
      sendGoal('b2b_messenger_click', { messenger: messenger });
    });
  }
  
  // =====================================================
  // ИНИЦИАЛИЗАЦИЯ
  // =====================================================
  
  function init() {
    if (!isTargetPage()) {
      if (CONFIG.debug) {
        console.log('[C2C Tracking] Not target page, skipping');
      }
      return;
    }
    
    if (CONFIG.debug) {
      console.log('[C2C Tracking] Initializing for', CONFIG.page);
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        trackForm();
        trackCTAButtons();
        trackCalculator();
        trackFAQ();
        trackContacts();
      });
    } else {
      trackForm();
      trackCTAButtons();
      trackCalculator();
      trackFAQ();
      trackContacts();
    }
  }
  
  init();
  
})();
```

---

## 6. Оптимизация в Яндекс.Директ

### 6.1. Проблема составных целей

Составная цель в Метрике — это **воронка** (последовательные шаги). Она НЕ работает как «любое из действий с весами».

### 6.2. Решение: Цель «B2B: Любая конверсия»

Скрипт выше отправляет событие `b2b_any_conversion` при каждом целевом действии с параметром `order_price` (ценность).

**В Директе:**
1. Кампания → Стратегия → Оптимизация конверсий
2. Выбрать цель: `B2B: Любая конверсия`
3. Директ будет учитывать ценность из `order_price`

### 6.3. Альтернатива: Несколько целей в Директе

В настройках стратегии Директа можно выбрать несколько целей:

```
Цели для оптимизации:
├── B2B: Форма отправлена — ценность 100 ₽
├── B2B: Клик по телефону — ценность 50 ₽
├── B2B: Клик в мессенджер — ценность 40 ₽
└── B2B: Калькулятор использован — ценность 20 ₽
```

### 6.4. Выбор стратегии

| Ситуация | Рекомендация |
|----------|--------------|
| >20 конверсий/неделю | Одна цель: «B2B: Форма отправлена» |
| 10-20 конверсий/неделю | «B2B: Любая конверсия» или несколько целей |
| <10 конверсий/неделю | «B2B: Любая конверсия» с ценностью |
| Есть данные из CRM | Офлайн-цель `b2b_deal_closed` |

---

## 7. Сегменты для ретаргетинга

### 7.1. Путь создания

Метрика → Отчёты → (любой отчёт) → Сегментация → Создать сегмент

Или: Метрика → Настройка → Сегменты

### 7.2. Рекомендуемые сегменты

**Сегмент: B2B — Горячие**
```
Условие: Достиг цели «B2B: Форма отправлена»
Использование: Исключить из рекламы (уже в воронке)
```

**Сегмент: B2B — Тёплые**
```
Условие: Достиг цели «B2B: Калькулятор использован»
И НЕ достиг цели «B2B: Форма отправлена»
Использование: Ретаргетинг с напоминанием
```

**Сегмент: B2B — Посетители**
```
Условие: Просмотр страницы URL содержит /dlya-biznesa
Использование: Ретаргетинг широкий
```

---

## 8. Тестирование

### 8.1. Проверка в реальном времени

1. Метрика → Отчёты → Стандартные → В реальном времени
2. Открыть `/dlya-biznesa` в соседней вкладке
3. Выполнить действия
4. Проверить фиксацию целей

### 8.2. Debug-режим скрипта

В `b2b-tracking.js` изменить:
```javascript
const CONFIG = {
  debug: true,  // Включить
  // ...
};
```

В консоли браузера:
```
[C2C Tracking] Goal: b2b_calc_used {from: "Москва", to: "Казань"}
[C2C Tracking] Also sent b2b_any_conversion with value: 20
```

### 8.3. Чек-лист

**JavaScript-события:**
- [ ] Отправка формы → `b2b_form_submit` + `b2b_any_conversion`
- [ ] Клик «Получить предложение» → `b2b_cta_offer` + `b2b_any_conversion`
- [ ] Клик «Рассчитать» → `b2b_calc_used` + `b2b_any_conversion`
- [ ] Клик «Рассчитать свой маршрут» → `b2b_calc_route` + `b2b_any_conversion`
- [ ] Клик по телефону → `b2b_phone_click` + `b2b_any_conversion`
- [ ] Клик в мессенджер → `b2b_messenger_click` + `b2b_any_conversion`
- [ ] Раскрытие FAQ → `b2b_faq_opened` + `b2b_any_conversion`

**Автоцели Метрики:**
- [ ] Клик по телефону → автоцель работает
- [ ] Клик по email → автоцель работает
- [ ] Клик в мессенджер → автоцель работает

---

## 9. Итоговый список целей

| № | Название | Тип | Создание |
|---|----------|-----|----------|
| 1 | B2B: Форма отправлена | JavaScript-событие | Вручную |
| 2 | B2B: Клик «Получить предложение» | JavaScript-событие | Вручную |
| 3 | B2B: Калькулятор использован | JavaScript-событие | Вручную |
| 4 | B2B: Клик «Рассчитать маршрут» | JavaScript-событие | Вручную |
| 5 | B2B: Клик по телефону | Клик по номеру телефона | Вручную |
| 6 | B2B: Клик по email | Клик по email | Вручную |
| 7 | B2B: Клик в мессенджер | Переход в мессенджер | Вручную |
| 8 | B2B: FAQ раскрыт | JavaScript-событие | Вручную |
| 9 | B2B: Любая конверсия | JavaScript-событие | Вручную |
| 10 | B2B: Воронка до заявки | Составная цель | Вручную |
| 11 | b2b_deal_closed | Офлайн-конверсия | Авто после загрузки |

---

## 10. Приоритет внедрения

| Шаг | Задача | Время |
|-----|--------|-------|
| 1 | Создать цели 1-9 в Метрике | 15 мин |
| 2 | Подключить `b2b-tracking.js` на страницу | 5 мин |
| 3 | Протестировать все события | 15 мин |
| 4 | Создать составную цель-воронку (10) | 5 мин |
| 5 | Настроить офлайн-конверсии | 10 мин |
| 6 | Создать сегменты | 10 мин |
| 7 | Настроить цели в Директе | 10 мин |

**Общее время:** ~1 час 10 минут

---

## 11. Ссылки

- Цели: https://yandex.ru/support/metrica/general/goals.html
- JavaScript API: https://yandex.ru/support/metrica/code/counter-js-api.html
- Составные цели: https://yandex.ru/support/metrica/general/composite-goal.html
- Офлайн-конверсии: https://yandex.ru/support/metrica/data/offline-conversion.html
- Сегменты: https://yandex.ru/support/metrica/segments.html
