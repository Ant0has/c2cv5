# Руководство: Динамический коллтрекинг Novofon + Яндекс.Метрика

**Проект:** city2city.ru
**Страница:** /dlya-biznesa
**Счётчик Метрики:** 36995060
**Дата:** 9 февраля 2026

---

## Содержание

1. [Как работает динамический коллтрекинг Novofon](#1-как-работает-динамический-коллтрекинг-novofon)
2. [Что нужно для подключения](#2-что-нужно-для-подключения)
3. [Пошаговая настройка коллтрекинга](#3-пошаговая-настройка-коллтрекинга)
4. [Установка скрипта на сайт city2city.ru](#4-установка-скрипта-на-сайт-city2cityru)
5. [Интеграция с Яндекс.Метрикой](#5-интеграция-с-яндексметрикой)
6. [Цели по звонкам в Метрике](#6-цели-по-звонкам-в-метрике)
7. [Настройка для Яндекс.Директ](#7-настройка-для-яндексдирект)
8. [API Novofon](#8-api-novofon)
9. [Совместная работа с существующим b2b-tracking.js](#9-совместная-работа-с-существующим-b2b-trackingjs)
10. [Тестирование и отладка](#10-тестирование-и-отладка)
11. [Чек-лист внедрения](#11-чек-лист-внедрения)

---

## 1. Как работает динамический коллтрекинг Novofon

### 1.1. Принцип работы

Динамический коллтрекинг (ДКТ) подменяет основной номер телефона на сайте уникальным номером для каждого посетителя. Это позволяет связать конкретный телефонный звонок с конкретным визитом на сайт, рекламным источником, UTM-метками и ClientID посетителя.

**Схема работы:**

```
Посетитель заходит на city2city.ru/dlya-biznesa
        |
        v
Скрипт Novofon определяет источник визита (UTM, реферер, прямой)
        |
        v
Основной номер на сайте подменяется на уникальный подменный номер
(закрепляется за посетителем на 12-15 минут)
        |
        v
Посетитель звонит на подменный номер
        |
        v
Звонок переадресуется на основной номер компании
        |
        v
Novofon фиксирует: ClientID, UTM-метки, источник, ключевое слово,
регион, устройство, историю посещений
        |
        v
Данные передаются в Яндекс.Метрику (2 раза в день)
```

### 1.2. Подменные номера

- Заранее покупается пул виртуальных номеров в Novofon
- Каждый посетитель на сайте видит свой уникальный номер вместо основного
- Номер закрепляется за посетителем на 12-15 минут
- Когда посетитель звонит на подменный номер, звонок переадресуется на реальный номер компании
- Novofon записывает все данные о звонке и связывает их с визитом

### 1.3. Что фиксируется при звонке

| Параметр | Описание |
|----------|----------|
| ClientID (Метрика) | Идентификатор посетителя в Яндекс.Метрике |
| utm_source | Источник трафика (yandex, google и т.д.) |
| utm_medium | Тип трафика (cpc, organic и т.д.) |
| utm_campaign | Название рекламной кампании |
| utm_term | Ключевое слово |
| utm_content | Содержимое объявления |
| URL страницы | Страница, с которой позвонил клиент |
| Источник перехода (реферер) | Откуда пришёл посетитель |
| Устройство | Тип устройства (desktop / mobile / tablet) |
| Регион | Географическое расположение посетителя |
| Дата и время звонка | Когда произошёл звонок |
| Длительность звонка | Сколько длился разговор |
| Статус звонка | Принят / пропущен |
| Запись разговора | Аудиозапись (при включении) |

### 1.4. Динамический vs. Статический коллтрекинг

| Параметр | Динамический (ДКТ) | Статический (СКТ) |
|----------|--------------------|--------------------|
| Назначение | Онлайн-реклама | Офлайн-реклама |
| Номеров нужно | Пул (5-20+) | 1 на источник |
| Точность | До конкретного посетителя | До рекламного канала |
| Данные | ClientID, UTM, ключевое слово | Только источник |
| Применение для city2city | Для Яндекс.Директ, SEO | Для наружной рекламы, визиток |

**Для city2city.ru/dlya-biznesa нужен динамический коллтрекинг** -- он позволяет отслеживать каждый звонок с рекламы в Яндекс.Директ до конкретного ключевого слова и объявления.

---

## 2. Что нужно для подключения

### 2.1. Аккаунт Novofon

- Регистрация на https://novofon.com/ (бесплатно)
- Тариф: Функционал коллтрекинга предоставляется **бесплатно** на всех тарифах
- Оплата: Только за аренду виртуальных номеров

### 2.2. Пул подменных номеров

**Формула расчёта количества номеров:**

```
Количество номеров = (количество визитов в день / 100) + 1
```

**Пример для city2city.ru:**

| Визитов в день | Номеров нужно | Стоимость примерно |
|----------------|---------------|---------------------|
| 50 | 2 | ~200-300 руб/мес |
| 100 | 2 | ~200-300 руб/мес |
| 200 | 3 | ~300-450 руб/мес |
| 500 | 6 | ~600-900 руб/мес |
| 1000 | 11 | ~1100-1650 руб/мес |

**Важно:**
- Номера должны быть подключены минимум на 3 месяца
- Для 100% охвата количество номеров должно покрывать пиковую нагрузку
- В личном кабинете Novofon есть калькулятор для расчёта нужного количества
- Рекомендуется выбирать номера того же региона, что и бизнес (Москва 495/499 или 8-800)

### 2.3. API-ключи Novofon

API-ключи нужны для программной интеграции. Для базовой настройки коллтрекинга через личный кабинет API-ключи **не обязательны**, но полезны для:
- Получения данных о звонках через webhook
- Автоматизации и интеграции с CRM
- Расширенной аналитики

**Как получить API-ключи:**

1. Личный кабинет Novofon
2. Перейти: **Настройки** -> **API и интеграции** (или: Пользователи АТС -> Редактирование пользователя -> Администратор -> API)
3. Активировать использование ключей API
4. Сгенерировать **User Key** (ключ пользователя) и **Secret Key** (секретный ключ)

### 2.4. Счётчик Яндекс.Метрики

- Счётчик **36995060** (уже установлен на city2city.ru)
- Доступ к аккаунту Яндекса, на котором создан счётчик
- Счётчик должен быть создан **вручную** (автоматические счётчики не поддерживают данные о звонках)

---

## 3. Пошаговая настройка коллтрекинга

### Шаг 1: Регистрация и вход в Novofon

1. Перейти на https://novofon.com/
2. Зарегистрироваться или войти в личный кабинет
3. Пополнить баланс для аренды номеров

### Шаг 2: Покупка виртуальных номеров

1. В личном кабинете перейти: **Мои номера** -> **Подключить номер**
2. Выбрать страну: Россия
3. Выбрать тип номера:
   - **Городской номер** (495/499 для Москвы) -- подходит для B2B
   - **8-800** -- бесплатный для звонящего, хорошо для конверсии
4. Купить необходимое количество номеров (см. формулу в разделе 2.2)
5. Оплатить минимум на 3 месяца

### Шаг 3: Добавление сайта в Novofon

1. Перейти: **Аналитика рекламы** -> **Настройки** -> **Сайты**
2. Нажать **Добавить сайт**
3. Указать домен: `city2city.ru`
4. **Скопировать сгенерированный код счётчика** -- он понадобится для установки на сайт
5. Сохранить

### Шаг 4: Настройка виртуальной АТС

1. Перейти: **Моя АТС** -> **Внутренние номера**
2. Настроить переадресацию на реальный номер компании:
   - Указать номер для переадресации входящих звонков
   - Настроить переадресацию для рабочего/нерабочего времени (по желанию)
3. Включить запись разговоров (облачное хранилище)
4. Настроить голосовое приветствие (по желанию)

### Шаг 5: Настройка маршрутизации входящих звонков

1. Перейти: **Моя АТС** -> **Входящие звонки**
2. Для каждого купленного подменного номера настроить сценарий:
   - **Простая переадресация** на основной номер, или
   - **Сценарий IVR** (голосовое меню), или
   - **Переадресация на конкретного сотрудника**
3. Протестировать: позвонить на каждый номер и убедиться, что звонок приходит

### Шаг 6: Создание правил коллтрекинга

1. Перейти: **Аналитика рекламы** -> **Коллтрекинг**
2. Выбрать **Динамический коллтрекинг (ДКТ)**
3. Настроить параметры:

**Основные настройки:**

| Параметр | Значение для city2city |
|----------|------------------------|
| Сайт | city2city.ru |
| Тип | Динамический |
| Целевая длительность звонка | 30 секунд (рекомендация) |
| ID Яндекс.Метрики | 36995060 |

**Настройка пула номеров:**

- Указать префикс (код города): 495, 499 или 800
- Указать максимальное количество посетителей в день
- Система автоматически рассчитает нужное количество номеров
- Выбрать купленные номера из списка

**Настройка блоков подмены:**

- Указать, где на сайте находится номер телефона
- Задать способ поиска: по номеру (рекомендуется), по CSS-классу или по селектору
- Указать маску номера (формат отображения)

**Настройка источников трафика:**

| Источник | Тип | Настройка |
|----------|-----|-----------|
| Яндекс.Директ | Динамический | utm_source=yandex, utm_medium=cpc |
| Органический поиск | Динамический | Реферер содержит yandex.ru или google.com |
| Прямой трафик | Динамический | Источник по умолчанию |
| Все остальные | Динамический | Источник по умолчанию |

### Шаг 7: Расширенные настройки

1. **Резервные номера:** включить показ резервных номеров при нехватке динамических
2. **IP-фильтрация:** добавить IP-адреса для исключения (офисные IP, боты)
3. **Формат номера:** настроить маску отображения: `+7 (XXX) XXX-XX-XX`
4. **Cookie-домен:** оставить по умолчанию для city2city.ru

---

## 4. Установка скрипта на сайт city2city.ru

### 4.1. Код счётчика Novofon

Код генерируется в личном кабинете Novofon: **Аналитика рекламы** -> **Настройки** -> **Сайты** -> city2city.ru

Примерный формат скрипта (точный код будет сгенерирован в ЛК):

```html
<!-- Novofon Call Tracking -->
<script type="text/javascript">
  // Код генерируется в личном кабинете Novofon
  // и содержит уникальный идентификатор вашего трекера
  (function(w,d,s,p,id){
    w._nfq=w._nfq||[];
    var js,fjs=d.getElementsByTagName(s)[0];
    if(d.getElementById(id))return;
    js=d.createElement(s);js.id=id;
    js.src=p;
    fjs.parentNode.insertBefore(js,fjs);
  })(window,document,'script','//analytics.novofon.com/tracker/ВАШ_ID_ТРЕКЕРА.js','novofon-ct');
</script>
<!-- /Novofon Call Tracking -->
```

> **ВАЖНО:** Точный код получите в личном кабинете Novofon. Приведённый выше -- примерный формат. Реальный код может отличаться.

### 4.2. Куда вставить скрипт

Скрипт нужно вставить **на все страницы сайта** перед закрывающим тегом `</head>`:

```html
<head>
  <!-- Другие мета-теги -->

  <!-- Яндекс.Метрика (уже установлена) -->
  <script type="text/javascript">
    (function(m,e,t,r,i,k,a){...})(window, document, "script",
    "https://mc.yandex.ru/metrika/tag.js", "ym");
    ym(36995060, "init", { clickmap:true, trackLinks:true,
    accurateTrackBounce:true, webvisor:true });
  </script>

  <!-- Novofon Call Tracking (ВСТАВИТЬ ЗДЕСЬ) -->
  <script type="text/javascript">
    // Код из личного кабинета Novofon
  </script>

</head>
```

**Альтернативный способ -- через Google Tag Manager (GTM):**

1. В GTM создать новый тег: **Пользовательский HTML**
2. Вставить код Novofon
3. Триггер: **All Pages** (все страницы)
4. Опубликовать контейнер

### 4.3. Добавление CSS-класса `zphone`

Для корректной подмены номеров необходимо добавить CSS-класс `zphone` ко всем HTML-элементам, содержащим номер телефона на сайте.

**Пример для обычного текста:**

```html
<!-- ДО -->
<div class="phone">+7 (495) 123-45-67</div>

<!-- ПОСЛЕ -->
<div class="phone zphone">+7 (495) 123-45-67</div>
```

**Пример для кликабельного номера (ссылка tel:):**

```html
<!-- ДО -->
<a href="tel:+74951234567">+7 (495) 123-45-67</a>

<!-- ПОСЛЕ -->
<a href="tel:+74951234567" class="zphone">+7 (495) 123-45-67</a>
```

> **ВАЖНО для кликабельных номеров:** Класс `zphone` должен быть назначен именно на тег `<a>`, чтобы подмена работала и для отображения номера, и для ссылки `tel:`.

**Места на сайте city2city.ru/dlya-biznesa, где нужно добавить `zphone`:**

- Номер телефона в шапке сайта (header)
- Номер телефона в блоке контактов
- Номер телефона в футере
- Любые другие места, где отображается телефон

**Альтернативный способ (без правки HTML):**

В настройках коллтрекинга в Novofon можно указать способ поиска номера:
- **По номеру телефона** -- система найдёт все вхождения указанного номера на странице
- **По CSS-селектору** -- указать свой CSS-класс или селектор
- **По id элемента** -- указать ID HTML-элемента

Если выбрать поиск "по номеру", то добавлять класс `zphone` не обязательно -- Novofon сам найдёт номер на странице. Однако класс `zphone` обеспечивает более надёжную и быструю подмену.

### 4.4. Пользовательский CSS-класс вместо zphone

Если вы предпочитаете использовать свой CSS-класс:

1. В настройках коллтрекинга Novofon найти поле **CSS-класс**
2. Ввести своё имя класса, например: `c2c-phone`
3. Можно указать несколько классов через пробел
4. Добавить этот класс к элементам на сайте

---

## 5. Интеграция с Яндекс.Метрикой

### 5.1. Настройка интеграции в Novofon

1. Войти в личный кабинет Novofon
2. Перейти: **Интеграции** (в левом меню) -> **Яндекс Метрика**
3. Нажать **Подключить**

**Шаг 1 -- Аккаунт:**
- Нажать "Создать новый аккаунт"
- Произойдёт перенаправление на страницу авторизации Яндекса
- Войти в аккаунт Яндекса, на котором создан счётчик 36995060
- Подтвердить доступ
- Вернуться в Novofon -- появится подтверждение успешного подключения

**Шаг 2 -- Трекер (счётчик):**
- В выпадающем списке выбрать счётчик **36995060** (city2city.ru)
- Убедиться, что код счётчика Метрики установлен на сайте

**Шаг 3 -- Сайт:**
- Выбрать сайт `city2city.ru` из списка
- Если сайта нет -- добавить через **Аналитика рекламы** -> **Настройки** -> **Сайты**

### 5.2. Настройка передачи событий

**Шаг 4 -- События:**

Создать событие для передачи звонков:

| Параметр | Значение |
|----------|----------|
| Название события | B2B: Звонок с сайта |
| Тип события | **Звонки** |
| Фильтры | (см. ниже) |

**Типы событий:**

| Тип | Описание | Дополнительная настройка в Метрике |
|-----|----------|-------------------------------------|
| **Звонки** | Передача как офлайн-звонков | Не требуется. Цель "Звонок" появится автоматически |
| **Звонки как JS-события** | Передача через JavaScript | Нужно создать цель "JavaScript-событие" в Метрике |
| **Заявки** | Передача как заявки | Нужно создать цель в Метрике |

**Рекомендация для city2city.ru:** Использовать тип **"Звонки"** -- это самый простой вариант, не требующий дополнительной настройки в Метрике.

### 5.3. Настройка фильтров

Доступно 40+ условий фильтрации. Рекомендуемые фильтры для city2city:

**Вариант 1: Передавать все звонки**
- Без фильтров -- все звонки передаются в Метрику

**Вариант 2: Только целевые звонки (рекомендуется)**
- Фильтр: Длительность разговора > 30 секунд
- Это исключает случайные и ошибочные звонки

**Вариант 3: Только первичные обращения**
- Фильтр: Первичное обращение = Да
- Рекомендуется для работы с автостратегиями Яндекс.Директ

**Вариант 4: Комбинация фильтров**
- Фильтр 1: Длительность > 30 секунд
- Фильтр 2: Первичное обращение = Да
- Самый строгий вариант, даёт только качественные лиды

> **Совет:** Для оптимизации автостратегий в Директе лучше передавать только первичные целевые обращения. Это даст стратегии более чистый сигнал для обучения.

### 5.4. Частота передачи данных

- Данные о звонках передаются из Novofon в Яндекс.Метрику **2 раза в день**
- Обработка на стороне Метрики может занять до **24 часов**
- Итого: задержка появления данных в отчётах -- от нескольких часов до суток

### 5.5. Мониторинг статуса интеграции

В Novofon отображается статус интеграции:

| Статус | Значение | Действие |
|--------|----------|----------|
| **Успешно** | Интеграция работает | Ничего не нужно |
| **Не работает** | Аккаунт не выбран или потерян доступ | Переподключить аккаунт Яндекса |
| **Требует внимания** | Настройка не завершена | Проверить все шаги настройки |

---

## 6. Цели по звонкам в Метрике

### 6.1. Автоматически создаваемые цели

При первой передаче данных о звонках из Novofon в Метрику **автоматически** (в течение суток) создаются 4 цели:

| Цель | Описание | Когда срабатывает |
|------|----------|-------------------|
| **Звонок** | Любой звонок | При каждом звонке, включая пропущенные |
| **Целевой звонок** | Звонок с длительным разговором | Разговор длился > 30 секунд |
| **Уникальный звонок** | Первый звонок от посетителя | Посетитель звонит впервые |
| **Уникально-целевой звонок** | Первый + длительный | Первый звонок И разговор > 30 секунд |

### 6.2. Как выглядят цели в Метрике

После автоматического создания цели появятся в:

**Путь:** Метрика -> Настройка -> Цели

Они будут отображаться рядом с уже настроенными целями:

```
Существующие цели (из b2b-tracking.js):
  - B2B: Форма отправлена (b2b_form_submit)
  - B2B: Клик «Получить предложение» (b2b_cta_offer)
  - B2B: Калькулятор использован (b2b_calc_used)
  - ...

Новые цели (от Novofon, автоматические):
  - Звонок
  - Целевой звонок
  - Уникальный звонок
  - Уникально-целевой звонок
```

### 6.3. Создание пользовательских целей по звонкам

Дополнительно можно создать в Метрике цели с кастомными условиями:

**Пример: B2B: Целевой звонок (> 60 сек)**
```
Метрика -> Настройка -> Цели -> Добавить цель
Название: B2B: Целевой звонок (> 60 сек)
Тип: Звонок
Условие: Длительность разговора > 60 секунд
```

**Пример: B2B: Звонок с Директа**
```
Название: B2B: Звонок с Яндекс.Директ
Тип: Звонок
Условие: Тег содержит "yandex" или источник = cpc
```

### 6.4. Отчёты по звонкам в Метрике

После настройки интеграции появятся специальные отчёты:

**Путь:** Метрика -> Отчёты -> Звонки

| Отчёт | Содержимое |
|--------|-----------|
| Детальные звонки | Список всех звонков с параметрами |
| Источники звонков | Откуда пришли звонящие |
| Качество звонков | Длительность, пропущенные, принятые |

Также цели по звонкам доступны **во всех стандартных отчётах** Метрики через добавление цели в отчёт.

---

## 7. Настройка для Яндекс.Директ

### 7.1. UTM-метки для кампаний в Директе

Для корректного отслеживания звонков из Яндекс.Директ необходимо правильно разметить объявления UTM-метками.

**Рекомендуемый шаблон UTM для Яндекс.Директ:**

```
?utm_source=yandex&utm_medium=cpc&utm_campaign={campaign_id}&utm_content={ad_id}&utm_term={keyword}
```

**С динамическими параметрами Директа:**

```
?utm_source=yandex&utm_medium=cpc&utm_campaign={campaign_name}&utm_content={ad_id}&utm_term={keyword}&yclid={yclid}
```

**Параметры динамической подстановки Яндекс.Директ:**

| Параметр | Описание |
|----------|----------|
| `{campaign_id}` | ID рекламной кампании |
| `{campaign_name}` | Название кампании |
| `{ad_id}` | ID объявления |
| `{keyword}` | Ключевая фраза |
| `{yclid}` | Идентификатор клика Яндекс.Директ |
| `{source}` | Площадка (для РСЯ) |
| `{region_name}` | Регион показа |
| `{device_type}` | Тип устройства |

### 7.2. Настройка ссылок в объявлениях

**В Яндекс.Директ:**

1. Перейти в кампанию
2. Открыть группу объявлений -> Редактировать
3. В поле **"Ссылка на сайт"** добавить UTM-метки:

```
https://city2city.ru/dlya-biznesa?utm_source=yandex&utm_medium=cpc&utm_campaign={campaign_name}&utm_content={ad_id}&utm_term={keyword}
```

### 7.3. Использование целей по звонкам в стратегии Директа

**Путь:** Яндекс.Директ -> Кампания -> Стратегия -> Оптимизация конверсий

После того как цели по звонкам появятся в Метрике, их можно использовать для оптимизации кампаний:

**Вариант 1: Оптимизация по целевым звонкам**
```
Цель: Целевой звонок
Ценность конверсии: (ваша ценность звонка, например 500 руб.)
```

**Вариант 2: Оптимизация по уникально-целевым звонкам**
```
Цель: Уникально-целевой звонок
Ценность конверсии: (ваша ценность нового клиента)
```

**Вариант 3: Комбинация звонков и других целей (рекомендуется)**
```
Цели для оптимизации:
  - Уникально-целевой звонок -- ценность 500 руб.
  - B2B: Форма отправлена -- ценность 300 руб.
  - B2B: Любая конверсия -- ценность 50 руб. (из b2b-tracking.js)
```

### 7.4. Рекомендации по стратегии оптимизации

| Ситуация | Рекомендация |
|----------|--------------|
| Мало звонков (<10/нед) | Оптимизация по "B2B: Любая конверсия" (включает клики по телефону + формы + мессенджеры + звонки) |
| 10-20 звонков/нед | Оптимизация по нескольким целям: звонки + формы |
| >20 звонков/нед | Оптимизация только по "Уникально-целевой звонок" |
| Есть данные из CRM | Оптимизация по офлайн-цели `b2b_deal_closed` |

### 7.5. Связка коллтрекинга с yclid

Параметр `yclid` (Yandex Click ID) автоматически добавляется Яндекс.Директом к URL. Если Novofon захватывает `yclid`, это позволяет:
- Точно привязать звонок к конкретному клику в Директе
- Использовать данные для офлайн-конверсий
- Получить более точную атрибуцию в отчётах Метрики

**Убедитесь, что в настройках кампании Директа:**
- Включена опция "Размечать ссылки для Метрики" (добавляет yclid автоматически)
- Указан номер счётчика Метрики: 36995060

---

## 8. API Novofon

### 8.1. Получение API-ключей

1. Личный кабинет Novofon
2. **Настройки** -> **API и интеграции** (или: Пользователи АТС -> Администратор -> API)
3. Активировать API
4. Сгенерировать ключи:
   - **User Key** (ключ пользователя)
   - **Secret Key** (секретный ключ)

### 8.2. Авторизация запросов

Формат заголовка авторизации:
```
Authorization: <user_key>:<signature>
```

**Алгоритм формирования подписи (PHP-пример):**

```php
<?php
ksort($params);
$paramsStr = http_build_query($params, null, '&', PHP_QUERY_RFC1738);
$sign = base64_encode(hash_hmac('sha1', $method . $paramsStr . md5($paramsStr), $secret));
$header = 'Authorization: ' . $userKey . ':' . $sign;
```

**Алгоритм:**
1. Отсортировать параметры по ключу (алфавитно)
2. Сформировать строку параметров (query string)
3. Склеить: имя метода + строка параметров + MD5 от строки параметров
4. Подписать HMAC-SHA1 с использованием Secret Key
5. Закодировать в Base64

### 8.3. Основные endpoint-ы API

**Базовый URL:** `https://api.novofon.com/v1/`

| Endpoint | Описание |
|----------|----------|
| `/v1/info/balance/` | Баланс аккаунта |
| `/v1/statistics/` | Общая статистика звонков |
| `/v1/statistics/pbx/` | Статистика АТС |
| `/v1/direct_numbers/` | Список виртуальных номеров |
| `/v1/sip/` | Список SIP-номеров |
| `/v1/request/callback/` | Инициировать обратный звонок |

### 8.4. Webhook CALL_TRACKING

Novofon может отправлять уведомления о звонках на коллтрекинговые номера через webhook:

**Тип события:** `CALL_TRACKING`

**Данные в webhook:**
- ID трекера
- ClientID посетителя (Метрика и GA)
- UTM-метки (source, medium, campaign, term, content)
- URL страницы
- ID звонка в АТС
- Данные о звонке (номер, длительность, статус)

**Настройка:**
1. В личном кабинете: **Настройки** -> **API и интеграции** -> **Webhooks**
2. Указать URL вашего обработчика
3. Выбрать события: CALL_TRACKING

### 8.5. Лимиты API

- 100 запросов в минуту
- Максимум 1000 строк на запрос
- Максимальный период статистики -- 30 дней за один запрос

### 8.6. Документация API

- Документация: https://api.novofon.com/
- GitHub (Novofon 2.0): https://novofon.github.io/data_api/
- PHP-пакет: https://github.com/novofon/user-api-v1

---

## 9. Совместная работа с существующим b2b-tracking.js

На сайте city2city.ru/dlya-biznesa уже установлен скрипт `b2b-tracking.js`, который отслеживает:
- Отправку формы (`b2b_form_submit`)
- Клик по CTA-кнопкам (`b2b_cta_offer`, `b2b_calc_route`)
- Использование калькулятора (`b2b_calc_used`)
- Клик по телефону (`b2b_phone_click`) -- через JavaScript-событие
- Клик в мессенджер (`b2b_messenger_click`)
- Раскрытие FAQ (`b2b_faq_opened`)
- Общая конверсия (`b2b_any_conversion`)

### 9.1. Что даёт коллтрекинг Novofon поверх b2b-tracking.js

| Параметр | b2b-tracking.js | Novofon коллтрекинг |
|----------|----------------|---------------------|
| Клик по телефону | Фиксирует факт клика по `tel:` ссылке | -- |
| Реальный звонок | Не может отследить | Фиксирует факт звонка |
| Длительность звонка | -- | Да, с точностью до секунды |
| Запись разговора | -- | Да |
| Звонок без клика (набрал вручную) | Не отслеживает | Отслеживает |
| Привязка к визиту | Через ClientID Метрики | Через ClientID + подменный номер |
| Данные о звонке | Только "был клик" | Полная информация: длительность, статус, запись |

**Ключевое преимущество:** Коллтрекинг фиксирует **реальные звонки**, а не только клики по ссылке `tel:`. Посетитель мог кликнуть по номеру, но не позвонить. Или наоборот -- увидел номер и набрал вручную с другого телефона (подменный номер отследит и это).

### 9.2. Рекомендуемая иерархия целей для Директа

С учётом коллтрекинга обновлённая иерархия ценности:

```
Цели для оптимизации в Яндекс.Директ (от высшей ценности к низшей):

1. b2b_deal_closed (CRM)                      -- 5000 руб. (реальная сделка)
2. Уникально-целевой звонок (Novofon)         -- 500 руб. (первый звонок > 30 сек)
3. Целевой звонок (Novofon)                   -- 300 руб. (звонок > 30 сек)
4. B2B: Форма отправлена (b2b_form_submit)    -- 200 руб. (заявка)
5. Звонок (Novofon)                            -- 100 руб. (любой звонок)
6. B2B: Клик по телефону (b2b_phone_click)     -- 50 руб. (клик, не звонок)
7. B2B: Клик в мессенджер (b2b_messenger_click)-- 40 руб.
8. B2B: Калькулятор использован (b2b_calc_used)-- 20 руб.
```

### 9.3. Конфликтов нет

Скрипт Novofon и `b2b-tracking.js` работают независимо и не конфликтуют:
- Novofon отвечает за подмену номеров на странице и передачу данных о звонках
- `b2b-tracking.js` отвечает за отслеживание JavaScript-событий (клики, формы, скролл)
- Оба передают данные в один счётчик Метрики 36995060
- Цели из разных источников дополняют друг друга

### 9.4. Порядок подключения скриптов на странице

```html
<head>
  <!-- 1. Яндекс.Метрика (первый -- для инициализации ym()) -->
  <script>
    (function(m,e,t,r,i,k,a){...})(window, document, "script",
    "https://mc.yandex.ru/metrika/tag.js", "ym");
    ym(36995060, "init", {...});
  </script>

  <!-- 2. Novofon Call Tracking (второй -- для подмены номеров) -->
  <script>
    // Код из личного кабинета Novofon
  </script>
</head>

<body>
  <!-- ... контент сайта ... -->

  <!-- Номера телефонов с классом zphone -->
  <a href="tel:+74951234567" class="zphone">+7 (495) 123-45-67</a>

  <!-- 3. b2b-tracking.js (в конце body -- для отслеживания событий) -->
  <script src="/b2b-tracking.min.js"></script>
</body>
```

---

## 10. Тестирование и отладка

### 10.1. Проверка подмены номеров

1. Открыть сайт city2city.ru/dlya-biznesa в режиме инкогнито
2. Проверить, что основной номер телефона подменился на другой
3. Открыть в другом браузере -- должен отображаться другой подменный номер
4. Позвонить на подменный номер -- звонок должен прийти на основной номер компании

### 10.2. Проверка в личном кабинете Novofon

1. Перейти: **Аналитика рекламы** -> **Отчёты**
2. Проверить, что тестовый звонок отобразился
3. Проверить, что зафиксированы UTM-метки и ClientID

### 10.3. Проверка интеграции с Метрикой

1. После тестового звонка подождать до следующей выгрузки (до 12 часов)
2. Перейти в Метрику: **Отчёты** -> **Звонки** -> **Детальные звонки**
3. Проверить наличие тестового звонка
4. Перейти: **Настройка** -> **Цели** -- проверить, что появились цели по звонкам

### 10.4. Проверка в Яндекс.Директ

1. Перейти в настройки кампании -> Стратегия
2. В списке целей для оптимизации должны появиться цели по звонкам
3. Если целей нет -- подождать до 48 часов после первой передачи данных

### 10.5. Частые проблемы

| Проблема | Причина | Решение |
|----------|---------|---------|
| Номер не подменяется | Скрипт не установлен или ошибка | Проверить установку скрипта и класс `zphone` |
| Подмена мигает | Скрипт загружается медленно | Перенести скрипт в `<head>` |
| Нет данных в Метрике | Интеграция не настроена | Проверить настройки интеграции в Novofon |
| Звонки не привязаны к визитам | Нет ClientID | Проверить, что Метрика установлена и работает |
| Не хватает номеров | Мало купленных номеров | Купить дополнительные номера |
| Ошибка при звонке | Не настроена переадресация | Настроить маршрутизацию в АТС |

---

## 11. Чек-лист внедрения

### Этап 1: Подготовка (30 мин)

- [ ] Зарегистрироваться в Novofon (https://novofon.com/)
- [ ] Пополнить баланс
- [ ] Рассчитать количество подменных номеров (визиты/день / 100 + 1)
- [ ] Купить виртуальные номера (мин. на 3 месяца)

### Этап 2: Настройка АТС (15 мин)

- [ ] Настроить переадресацию с подменных номеров на основной номер
- [ ] Включить запись разговоров
- [ ] Протестировать: позвонить на подменные номера

### Этап 3: Настройка коллтрекинга (20 мин)

- [ ] Добавить сайт city2city.ru в Novofon (Аналитика рекламы -> Настройки -> Сайты)
- [ ] Скопировать код счётчика Novofon
- [ ] Создать правило динамического коллтрекинга
- [ ] Настроить блоки подмены номеров
- [ ] Указать пул номеров и формат отображения
- [ ] Настроить источники трафика (UTM для Директа, органика, прямой)
- [ ] Включить резервные номера
- [ ] Настроить IP-фильтрацию (исключить офисные IP)

### Этап 4: Установка на сайт (15 мин)

- [ ] Вставить скрипт Novofon в `<head>` на всех страницах city2city.ru
- [ ] Добавить CSS-класс `zphone` ко всем элементам с телефоном
- [ ] Проверить подмену номера на странице /dlya-biznesa
- [ ] Проверить подмену номера в шапке и футере
- [ ] Проверить, что кликабельные номера (tel:) тоже подменяются

### Этап 5: Интеграция с Метрикой (15 мин)

- [ ] Подключить аккаунт Яндекса в Novofon (Интеграции -> Яндекс Метрика)
- [ ] Выбрать счётчик 36995060
- [ ] Выбрать сайт city2city.ru
- [ ] Создать событие "Звонки" (тип: Звонки)
- [ ] Настроить фильтры (рекомендуется: целевые + первичные)
- [ ] Проверить статус интеграции: "Успешно"

### Этап 6: Настройка Яндекс.Директ (15 мин)

- [ ] Добавить UTM-метки в объявления Директа
- [ ] Убедиться, что "Размечать ссылки для Метрики" включено
- [ ] Убедиться, что указан счётчик 36995060 в настройках кампании
- [ ] Дождаться появления целей по звонкам в Метрике (до 48 ч)
- [ ] Добавить цели по звонкам в стратегию оптимизации кампании
- [ ] Установить ценность конверсии для целей по звонкам

### Этап 7: Тестирование (20 мин)

- [ ] Открыть сайт в инкогнито -- номер подменился
- [ ] Открыть в другом браузере -- номер другой
- [ ] Позвонить на подменный номер -- звонок дошёл
- [ ] Проверить запись разговора в Novofon
- [ ] Проверить UTM-метки в отчёте Novofon
- [ ] Дождаться появления звонка в Метрике
- [ ] Проверить цели по звонкам в Метрике

**Общее время внедрения:** ~2 часа (+ ожидание синхронизации данных до 48 ч)

---

## 12. Полезные ссылки

**Novofon:**
- Коллтрекинг: https://novofon.com/calltracking/
- Инструкция по настройке: https://novofon.com/instructions/novofon/calltracking/
- Видеоинструкция: https://novofon.com/instructions/video/kak-nastroit-dinamicheskiy-kolltreking/
- Интеграция с Яндекс Метрикой: https://novofon.com/instructions/integration/yandex-metrika/
- API документация: https://api.novofon.com/
- API GitHub: https://novofon.github.io/data_api/
- Инструкция по API: https://novofon.com/instructions/api/
- Блог: телефония и аналитика: https://novofon.com/blog/telefonia-i-analitika/

**Яндекс:**
- Цели по звонкам в Метрике: https://yandex.ru/support/metrica/general/call-goal.html
- Отслеживание звонков в Метрике: https://yandex.ru/support/metrica/data/calls.html
- Колл-трекеры для Метрики (список партнёров): https://yandex.ru/dev/metrika-calltracking/
- Офлайн-конверсии: https://yandex.ru/dev/metrika/doc/api2/practice/offline-conv.html

---

## 13. Стоимость

| Компонент | Стоимость |
|-----------|-----------|
| Функционал коллтрекинга Novofon | **Бесплатно** |
| Аренда виртуальных номеров (Москва) | ~100-150 руб/мес за номер |
| Аренда номера 8-800 | ~250-400 руб/мес за номер |
| Минуты разговора | Зависят от тарифа и направления |
| Интеграция с Метрикой | **Бесплатно** |

**Примерный бюджет для city2city (5 номеров Москва):**
~500-750 руб/мес за номера + стоимость минут разговора.
